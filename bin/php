#!/usr/bin/env bash

PHP_VERSION=""
if command -v mise &> /dev/null; then
  PHP_VERSION=$(mise current php 2>/dev/null | awk '{print $2}')
fi

if [ -n "$PHP_VERSION" ]; then
  DEFAULT_IMAGE="mise-php-docker:${PHP_VERSION}"
else
  DEFAULT_IMAGE="mise-php-docker:8"
fi

IMAGE="${PHP_DOCKER_IMAGE:-$DEFAULT_IMAGE}"

if ! docker image inspect "$IMAGE" &> /dev/null; then
  echo "Building Docker image $IMAGE..." >&2
  PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
  docker build -t "$IMAGE" "$PLUGIN_DIR" || {
    echo "Failed to build Docker image" >&2
    exit 1
  }
fi

XDEBUG_ENABLED="${XDEBUG_MODE:-off}"

DOCKER_ARGS=(
  "--rm"
  "-v" "$(pwd):/app"
  "-w" "/app"
)

if [ -t 0 ]; then
  DOCKER_ARGS+=("-it")
else
  DOCKER_ARGS+=("-i")
fi

if [ "$XDEBUG_ENABLED" != "off" ]; then
  DOCKER_ARGS+=(
    "-e" "XDEBUG_MODE=${XDEBUG_ENABLED}"
    "-p" "9003:9003"
    "--add-host=host.docker.internal:host-gateway"
  )
fi

docker run "${DOCKER_ARGS[@]}" "$IMAGE" php "$@"
