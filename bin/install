#!/usr/bin/env bash
set -euo pipefail

ARGS=("$@")
ARG_COUNT=${#ARGS[@]}

VERSION=""
INSTALL_DIR=""

if [ "$ARG_COUNT" -ge 2 ]; then
  INSTALL_DIR="${ARGS[$((ARG_COUNT - 1))]}"
  VERSION="${ARGS[$((ARG_COUNT - 2))]}"
elif [ "$ARG_COUNT" -eq 1 ]; then
  VERSION="${ARGS[0]}"
fi

VERSION="${VERSION:-${RTX_INSTALL_VERSION:-${MISE_INSTALL_VERSION:-}}}"
INSTALL_DIR="${INSTALL_DIR:-${RTX_INSTALL_PATH:-${MISE_INSTALL_PATH:-}}}"

if [ -z "$VERSION" ] || [ -z "$INSTALL_DIR" ]; then
  echo "Usage: install <version> <install_dir>" >&2
  exit 1
fi

PLUGIN_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Normalize PHP version to major.minor format for Docker base image
# Examples: 7.4.33 -> 7.4, 8.2.5 -> 8.2, 8 -> 8
normalize_php_version() {
  local version="$1"
  # Extract major.minor (e.g., 7.4.33 -> 7.4, 8.2.5 -> 8.2)
  # If version is already major.minor or just major, keep it as is
  echo "$version" | sed -E 's/^([0-9]+(\.[0-9]+)?).*/\1/' || echo "$version"
}

mkdir -p "$(dirname "$INSTALL_DIR")"
rm -rf "$INSTALL_DIR"
mkdir -p "$INSTALL_DIR/bin"

cp "$PLUGIN_ROOT/bin/php" "$INSTALL_DIR/bin/php"
cp "$PLUGIN_ROOT/bin/composer" "$INSTALL_DIR/bin/composer"
cp "$PLUGIN_ROOT/bin/php-shell" "$INSTALL_DIR/bin/php-shell"
chmod +x "$INSTALL_DIR/bin/php" "$INSTALL_DIR/bin/composer" "$INSTALL_DIR/bin/php-shell"

cp "$PLUGIN_ROOT/Dockerfile" "$INSTALL_DIR/Dockerfile"

echo "$VERSION" > "$INSTALL_DIR/.mise-version"

IMAGE_TAG="mise-php-docker:${VERSION}"

if [ "$VERSION" != "system" ] && command -v docker &> /dev/null; then
  PHP_BASE_VERSION=$(normalize_php_version "$VERSION")
  echo "Building Docker image ${IMAGE_TAG} for PHP ${VERSION} (using base image php:${PHP_BASE_VERSION}-cli)..." >&2
  if ! docker build -t "$IMAGE_TAG" --build-arg "PHP_VERSION=${PHP_BASE_VERSION}" "$INSTALL_DIR"; then
    echo "Failed to build Docker image ${IMAGE_TAG}" >&2
    exit 1
  fi
else
  echo "Skipping Docker image build (docker not available or system version requested)." >&2
fi
